# ============================================================================
# Modern Tmux Configuration
# Optimized for tmux 3.0+ with essential plugins and modern features
# ============================================================================

# Basic settings
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",*256col*:Tc"  # True color support
set -g history-limit 10000
set -g buffer-limit 20
set -sg escape-time 1
set -g display-time 1500
set -g remain-on-exit off
set -g repeat-time 300

# Keep default prefix Ctrl-b
# unbind C-b
# set -g prefix C-a
# bind C-a send-prefix

# Session settings
set -g base-index 1          # Start window numbering at 1
setw -g pane-base-index 1    # Start pane numbering at 1
set -g renumber-windows on   # Renumber windows when one is closed

# Enable mouse support
set -g mouse on

# Vi mode settings
setw -g mode-keys vi
set -g status-keys emacs

# Vi-style copy mode
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel
bind -T copy-mode-vi r send-keys -X rectangle-toggle

# System clipboard integration (requires xclip/pbcopy)
if-shell "command -v pbcopy > /dev/null 2>&1" \
    "bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel 'pbcopy'"
if-shell "command -v xclip > /dev/null 2>&1" \
    "bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel 'xclip -in -selection clipboard'"

# Key bindings
# Reload configuration
bind r source-file ~/.tmux.conf \; display "Configuration Reloaded!"

# Pane splitting (intuitive keys)
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
bind _ split-window -v -c "#{pane_current_path}"
unbind '"'
unbind %

# Pane navigation (vim-like)
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Pane resizing
bind -r H resize-pane -L 2
bind -r J resize-pane -D 2
bind -r K resize-pane -U 2
bind -r L resize-pane -R 2

# Window navigation
bind -r C-p select-window -t :-
bind -r C-n select-window -t :+

# Quick window selection
bind -r Tab last-window

# Session navigation
bind C-s choose-session

# New windows/panes in current directory
bind c new-window -c "#{pane_current_path}"

# Kill pane/window shortcuts
bind x kill-pane
bind X kill-window

# Clear screen and history
bind C-l send-keys 'C-l' \; clear-history

# Activity monitoring
setw -g monitor-activity on
set -g visual-activity on
set -g activity-action other

# Don't auto-rename windows
set -g allow-rename off

# ============================================================================
# Status Bar Configuration
# ============================================================================

# Status bar general
set -g status on
set -g status-interval 5
set -g status-position bottom
set -g status-justify left

# Status bar colors (modern dark theme)
set -g status-style "fg=#ffffff,bg=#1e1e2e"

# Status left
set -g status-left-length 30
set -g status-left "#[fg=#a6e3a1,bg=#313244] #S #[fg=#313244,bg=#1e1e2e]"

# Status right
set -g status-right-length 50
set -g status-right "#[fg=#313244,bg=#1e1e2e]#[fg=#ffffff,bg=#313244] %H:%M #[fg=#a6e3a1,bg=#313244]#[fg=#1e1e2e,bg=#a6e3a1] %d-%b "

# Window status
setw -g window-status-format " #I:#W#F "
setw -g window-status-current-format "#[fg=#1e1e2e,bg=#89b4fa] #I:#W#F #[fg=#89b4fa,bg=#1e1e2e]"
setw -g window-status-style "fg=#cdd6f4,bg=#1e1e2e"
setw -g window-status-current-style "fg=#1e1e2e,bg=#89b4fa,bold"

# Pane borders
set -g pane-border-style "fg=#6c7086,bg=default"
set -g pane-active-border-style "fg=#89b4fa,bg=default"

# Message styling
set -g message-style "fg=#ffffff,bg=#f38ba8"
set -g message-command-style "fg=#ffffff,bg=#f9e2af"

# ============================================================================
# Plugin Configuration
# ============================================================================

# List of plugins (minimal but essential)
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'christoomey/vim-tmux-navigator'

# Plugin settings

# tmux-resurrect
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-processes 'ssh'
set -g @resurrect-strategy-vim 'session'

# tmux-continuum (auto-save sessions)
set -g @continuum-restore 'on'
set -g @continuum-save-interval '15'

# ============================================================================
# SSH Agent Forwarding
# ============================================================================

# Remove SSH_AUTH_SOCK to disable auto-resetting
set -g update-environment "DISPLAY SSH_ASKPASS SSH_AGENT_PID SSH_CONNECTION WINDOWID XAUTHORITY"

# Use a symlink for SSH authentication
setenv -g SSH_AUTH_SOCK $HOME/.ssh/ssh_auth_sock

# ============================================================================
# Additional Useful Features
# ============================================================================

# Enable focus events (for vim/neovim)
set -g focus-events on

# Aggressive resize (only resize if active session is smaller)
setw -g aggressive-resize on

# Don't wrap searches in copy mode
setw -g wrap-search off

# ============================================================================
# Custom Functions and Advanced Key Bindings
# ============================================================================

# Quick session switching
bind s display-popup -E "tmux list-sessions | sed -E 's/:.*$//' | grep -v \"^$(tmux display-message -p '#S')\$\" | fzf --reverse | xargs tmux switch-client -t"

# Quick window switching with preview
bind w display-popup -E "tmux list-windows -F '#I:#W' | fzf --reverse | cut -d: -f1 | xargs tmux select-window -t"

# Show pane numbers longer
set -g display-panes-time 2000

# Synchronize panes toggle
bind S setw synchronize-panes

# Create predefined layouts
bind M-1 select-layout even-horizontal
bind M-2 select-layout even-vertical
bind M-3 select-layout main-horizontal
bind M-4 select-layout main-vertical
bind M-5 select-layout tiled

# ============================================================================
# Conditional Configuration
# ============================================================================

# macOS specific settings
if-shell "uname | grep -q Darwin" {
    # macOS clipboard integration
    set -g default-command "reattach-to-user-namespace -l ${SHELL}"
    bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "reattach-to-user-namespace pbcopy"
}

# Linux specific settings  
if-shell "uname | grep -q Linux" {
    # Linux clipboard integration
    bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "xclip -selection clipboard -i"
}

# ============================================================================
# Initialize TPM (keep this at the very bottom)
# ============================================================================
run '~/.tmux/plugins/tpm/tpm'